<html>
<script src="run.js"></script>
<script src="marcher-energy.js"></script>
<script src="tx2-energy.js"></script>
<script src="authority.js"></script>
<script src="instance.js"></script>
<script src="bigrams.js"></script>
<script src="trigrams.js"></script>
<script src="synthetic.js"></script>

<script src="pako.min.js"></script>

<input type="file" id="replay" multiple>
<script>
    function factorial(value)
    {
        if (value < 0)
        {
            return -1;
        }
        else if (value == 0)
        {
            return 1;
        }
        else
        {
            return (value * factorial(value-1));
        }
    }

    function updateOutput()
    {
        var raw = analyzers[2].energyUsage()

        var scaled = raw;
        var selected = document.getElementById("selection").selectedIndex
        var n = document.getElementById("BigO").value
        var c = document.getElementById("Constant").value
        switch(selected)
        {
            case 0: // Constant
                break;
            case 1: // Double Logarithmic
                scaled*=Math.log10(Math.log10(n))
                break;
            case 2: // Logarithmic
                var factor = Math.log10(n)
                scaled*=factor
                break;
            case 3: // Polylogarithmic
                scaled*=Math.pow(Math.log10(n), c)
                break;
            case 4: // Fractional Power
                scaled*=Math.pow(n,1/c)
                break;
            case 5: // Linear
                scaled*=n
                break;
            case 6: // N Log-Star N
                break;
            case 7: // Linearithmic
                scaled*=(n*Math.log10(n))
                break;
            case 8: // Quadratic
                scaled*=Math.pow(n,2)
                break;
            case 9: // Polynomial
                scaled*=Math.pow(n,c)
                break;
            case 10: // Exponential
                scaled*=Math.pow(c,n)
                break;
            case 11: // Factorial
                scaled*=factorial(n)
                break;
        }

        document.getElementById("output").value  = "Coverage " + analyzers[0].percentCoverage() + "%\n"
        document.getElementById("output").value += "Energy Usage (J) " +  scaled + "\n"
    }

    function updateText()
    {
        var name = document.getElementById("algorithm")

        var selected = document.getElementById("selection").selectedIndex
        name.innerHTML=names[selected]
        updateOutput();
    }

    var names = [
        "O(1)",
        "O(log log n)",
        "O(log n)",
        "O((log n)<sup>c</sup>)",
        "O(n<sup>1/c</sup>)",
        "O(n)",
        "O(n log* n)",
        "O(n log n)",
        "O(n<sup>2</sup>)",
        "O(n<sup>c</sup>)",
        "O(c<sup>n</sup>)",
        "O(n!)"
    ]

    replay.addEventListener('change', function(event)
    {
          var i = 0;
          while(i < replay.files.length)
          {
              var file = replay.files[i];
              if(!file)
              {
                  continue;
              }

              var reader = new FileReader();
              reader.onloadend = function(event)
              {
                  if(event.target.readyState == FileReader.DONE)
                  {
                      console.log("Unpacking... " + event.target.fileName)
                      var result = window.pako.inflate(event.target.result);
                      var text = new TextDecoder("utf-8").decode(result)
                      run = JSON.parse(text);
                      if(analyzers == null)
                      {
                          analyzers = [new Coverage(run.size), new Category(), new Energy(run.triple)]
                      }
                      analyze(run);
                      updateOutput();
                  }
              };
              reader.fileName = file.name
              reader.readAsArrayBuffer(file.slice(0, file.size));
              i++;
          }
    }, false);
</script>
<br>
<button onclick="instance()">Build Instance Table</button>
<button onclick="synthetic(2)">Build Synthetic 2-Gram Table</button>
<button onclick="synthetic(3)">Build Synthetic 3-Gram Table</button>
<script>
    function instance()
    {
        buildInstanceMap(run)

        var text = ""
        var total = 0
        var keys = instrMap.keys()
        for(var i = 0; i < instrMap.size; i++)
        {
            var key = keys.next()
            var count = instrMap.get(key.value)
            text += key.value + " " + count + "\n"
            total+=count
        }
        document.getElementById("output").value = text + total + "\n"
    }

    function synthetic(n)
    {
        buildSyntheticInstanceMap(run, n)

        var text = ""
        var total = 0
        var keys = synthMap.keys()
        for(var i = 0; i < synthMap.size; i++)
        {
            var key = keys.next()
            var count = synthMap.get(key.value)
            text += key.value + " " + count + "\n"
            total+=count
        }
        document.getElementById("output").value = text + total + "\n"
    }
</script>
<br>
<textarea id="output" style="width: 512px; height: 512px"></textarea>
<br>
<table style="width: 512px;">
<tr>
<td><p id="algorithm">O(1)</p></td>
<td><p>n</p></td>
<td><p>c</p></td>
</tr>
<tr>
<td>
    <select id="selection" onchange="updateText()">
        <option>Constant</option>
        <option>Double Logarithmic</option>
        <option>Logarithmic</option>
        <option>Polylogarithmic</option>
        <option>Fractional Power</option>
        <option>Linear</option>
        <option>N Log-Star N</option>
        <option>Linearithmic</option>
        <option>Quadratic</option>
        <option>Polynomial</option>
        <option>Exponential</option>
        <option>Factorial</option>
    </select>
</td>
<td>
    <input type="number" id="BigO" min="1" value="1">
</td>
<td>
    <input type="number" id="Constant" min="1" value="1">
</td>
<td>
    <input type="button" onclick="updateText()">
</td>
</tr>
</table>
<script>
    if(run != null)
    {
        analyze(run);
        document.getElementById("replay").style.display = "none"
    }
</script>
<br>
<form method="get" action="sample.zip">
    <button type="submit">Download sample</button>
</form>
</html>
